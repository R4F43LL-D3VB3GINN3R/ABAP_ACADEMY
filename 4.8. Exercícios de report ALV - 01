*&---------------------------------------------------------------------*
*& Report ZREPORT_ALV_2
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zreport_alv_2.

*Criar um relatório do tipo ALV com o título (Relatório de Ordens de Venda em
*Moeda EURO), conforme descrito abaixo:

TABLES: vbak,  "Tabela Transparente - Documento de Vendas: Dados de Cabeçalho
        vbap,  "Tabela Transparente - Documento de Vendas: Dados de Item
        lips,  "Tabela Transparente - Documento SD: Fornecimento: Dados de Item
        kna1,  "Tabela Transparente - Mestre de Clientes (Parte Geral)
        makt,  "Tabela Transparente - Textos Breves de Material
        tgsbt. "Tabela Transparente - Denominação das Divisões da Empresa

"---------------
"TELA DE SELEÇÃO
"---------------

SELECTION-SCREEN SKIP 1.
SELECTION-SCREEN BEGIN OF BLOCK a1 WITH FRAME TITLE TEXT-001.
  SELECT-OPTIONS: s_vbeln FOR vbak-vbeln, "Documento de Vendas
                  s_erdat FOR vbak-erdat, "Data de Criação do Registro
                  s_kunnr FOR vbak-kunnr. "Emissor da Ordem
SELECTION-SCREEN END OF BLOCK a1.
SELECTION-SCREEN SKIP 1.

"-------------------------------------------------------------------------------------------------------------------"
"-------------------------------------------------------------------------------------------------------------------"
"-------------------------------------------------------------------------------------------------------------------"
"Variáveis - Estruturas - Tabelas

  "-----------------------

  TYPES: BEGIN OF ty_vbak, "Estrutura - Documento de Vendas: Dados de Cabeçalho
    vbeln TYPE vbak-vbeln, "Documento de Vendas
    erdat TYPE vbak-erdat, "Data de Criação do Registro
    netwr TYPE vbak-netwr, "Valor Líquido da Ordem na Moeda do Documento
    kunnr TYPE vbak-kunnr, "Emissor da Ordem
  END OF ty_vbak.

  DATA: t_vbak  TYPE TABLE OF ty_vbak, "Tabela Interna - Estrutura - Documento de Vendas: Dados de Cabeçalho
        ls_vbak TYPE ty_vbak.          "Estrutura - Estrutura - Documento de Vendas: Dados de Cabeçalho

  "-----------------------

  TYPES: BEGIN OF ty_vbap, "Estrutura - Documento de Vendas: Dados de Item
    vbeln TYPE vbap-vbeln, "Documento de Vendas
    posnr TYPE vbap-posnr, "Item do Documento de Vendas
    matnr TYPE vbap-matnr, "Número do Material
    gsber TYPE vbap-gsber, "Divisão.
  END OF ty_vbap.

  DATA: t_vbap  TYPE TABLE OF ty_vbap, "Tabela Interna - Estrutura - Documento de Vendas: Dados de Item
        ls_vbap TYPE ty_vbap.          "Estrutura - Estrutura - Documento de Vendas: Dados de Item

   "-----------------------

  TYPES: BEGIN OF ty_lips, "Estrutura - Documento SD: Fornecimento: Dados de Item
    vbeln TYPE lips-vbeln, "Documento de Vendas
    posnr TYPE lips-posnr, "Item do Documento de Vendas
    vgbel TYPE lips-vgbel, "Nº Documento do Documento de Referência
    vgpos TYPE lips-vgpos, "Nº Item do Item Comercial Modelo
  END OF ty_lips.

  DATA: t_lips  TYPE TABLE OF ty_lips, "Tabela Interna - Estrutura - Documento SD: Fornecimento: Dados de Item
        ls_lips TYPE ty_lips.          "Estrutura - Estrutura - Documento SD: Fornecimento: Dados de Item

  "-----------------------

  TYPES: BEGIN OF ty_kna1, "Estrutura - Mestre de Clientes (Parte Geral)
    kunnr TYPE kna1-kunnr, "Nº do Cliente
    name1 TYPE kna1-name1, "Nome do Cliente
  END OF ty_kna1.

  DATA: t_kna1  TYPE TABLE OF ty_kna1, "Tabela Interna - Estrutura - Mestre de Clientes (Parte Geral)
        ls_kna1 TYPE ty_kna1.          "Estrutura - Estrutura - Mestre de Clientes (Parte Geral)

  "-----------------------

  TYPES: BEGIN OF ty_makt, "Estrutura - Textos Breves de Material
    matnr TYPE makt-matnr, "Número do Material
    maktx TYPE makt-maktx, "Texto Breve de Material
  END OF ty_makt.

  DATA: t_makt  TYPE TABLE OF ty_makt, "Tabela Interna- Estrutura - Textos Breves de Material
        ls_makt TYPE ty_makt.          "Estrutura - Estrutura - Textos Breves de Material

  "-----------------------

  TYPES: BEGIN OF ty_tgsbt, "Estrutura - Denominação das Divisões da Empresa
    gsber TYPE tgsbt-gsber, "Divisão
    gtext TYPE tgsbt-gtext, "Denominação da Divisão
  END OF ty_tgsbt.

  DATA: t_tgsbt  TYPE TABLE OF ty_tgsbt, "Tabela Interna - Estrutura - Denominação das Divisões da Empresa
        ls_tgsbt TYPE ty_tgsbt.          "Estrutura - Estrutura - Denominação das Divisões da Empresa

  "-----------------------

  TYPES: BEGIN OF ty_output, "Estrutura - Tabela de Saída
    vbeln TYPE vbak-vbeln,   "Documento de Vendas -                          [Documento de Vendas: Dados de Cabeçalho]
    erdat TYPE vbak-erdat,   "Data de Criação do Registro -                  [Documento de Vendas: Dados de Cabeçalho]
    netwr TYPE vbak-netwr,   "Valor Líquido da Ordem na Moeda do Documento - [Documento de Vendas: Dados de Cabeçalho]
    kunnr TYPE vbak-kunnr,   "Emissor da Ordem -                             [Documento de Vendas: Dados de Cabeçalho]
    posnr TYPE vbap-posnr,   "Item do Documento de Vendas -                  [Documento de Vendas: Dados de Item]
    matnr TYPE vbap-matnr,   "Número do Material -                           [Documento de Vendas: Dados de Item]
    gsber TYPE vbap-gsber,   "Divisão -                                      [Documento de Vendas: Dados de Item]
    vgbel TYPE lips-vgbel,   "Nº Documento do Documento de Referência -      [Documento SD: Fornecimento: Dados de Item]
    vgpos TYPE lips-vgpos,   "Nº Item do Item Comercial Modelo -             [Documento SD: Fornecimento: Dados de Item]
    name1 TYPE kna1-name1,   "Nome do Cliente -                              [Mestre de Clientes (Parte Geral)]
    maktx TYPE makt-maktx,   "Texto Breve de Material -                      [Textos Breves de Material]
    gtext TYPE tgsbt-gtext,  "Denominação da Divisão -                       [Denominação das Divisões da Empresa]
  end of ty_output.



"-------------------------------------------------------------------------------------------------------------------"
"-------------------------------------------------------------------------------------------------------------------"
"-------------------------------------------------------------------------------------------------------------------"

start-of-selection.
  PERFORM get_sales_doc.
  PERFORM get_data_item.
  PERFORM get_data_delivery.
  PERFORM get_client.
  PERFORM get_text_item.
  PERFORM get_division_text.
  PERFORM data_processing.
END-OF-SELECTION.

*&---------------------------------------------------------------------*
*& Form get_sales_doc
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_sales_doc.

*Selecionar na tabela VBAK os campos VBELN, ERDAT, NETWR e KUNNR, onde
*VBAK-VBELN IN S_VBELN e VBAK-ERDAT IN S_ERDAT e VBAK-KUNNR IN
*S_KUNNR e VBAK-AUART = ‘TA’ e VBAK-WAERK = ‘EUR’. Para testes preencher o
*parâmetro S_ERDAT o período de 01.01.2008 a 31.12.2008. Armazenar registros na
*tabela interna T_VBAK.

  SELECT vbeln, "Selecione o Documento de Vendas
         erdat, "Data de Criação do Registro
         netwr, "Valor Líquido da Ordem na Moeda do Documento
         kunnr  "Emissor da Ordem
         FROM vbak "Da Tabela Transparente - Documento de Vendas: Dados de Cabeçalho
         INTO CORRESPONDING FIELDS OF TABLE @t_vbak "Nos campos correspondentes da Tabela Interna - Documento de Vendas: Dados de Cabeçalho
         WHERE vbeln IN @s_vbeln "Onde o Documento de Vendas está no range do campo de múltipla escolha
         AND erdat IN @s_erdat "E a Data de Criação do Registro está no range do campo de múltipla escolha
         AND kunnr IN @s_kunnr "E o Emissor da Ordem está no range do campo de múltipla escolha
         AND auart = 'TA' "E o Tipo de Documento de Vendas  é 'TA'
         AND waerk = 'EUR'. "E a Moeda do Documento for Euro.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_data_item
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_data_item .

*Selecionar na tabela VBAP os campos VBELN, POSNR, MATNR e GSBER,
*relacionados com T_VBAK, onde VBAP-VBELN = T_VBAK-VBELN. Armazenar registros
*na tabela interna T_VBAP.

*+-------------+     +--------------+
*|   VBAK      |     |   VBAP       |
*+-------------+     +--------------+
*| VBELN (PK)  |<--->| VBELN (FK,PK)|
*| ...         |     | POSNR (PK)   |
*+-------------+     | ...          |
*                    +--------------+

  SELECT vbeln, "Selecione o Documento de Vendas
         posnr, "Item do Documento de Vendas
         matnr, "Número do Material
         gsber  "Divisão
         FROM vbap "Da Tabela Transparente - Documento de Vendas: Dados de Item
         INTO CORRESPONDING FIELDS OF TABLE @t_vbap "Nos campos correspondentes da Tabela Interna - Documento de Vendas: Dados de Item
         FOR ALL ENTRIES IN @t_vbak "Relacionada com a Tabela Interna - Documento de Vendas: Dados de Cabeçalho
         WHERE vbeln = @t_vbak-vbeln. "Onde o Documento de Vendas é o mesmo.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_data_delivery
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_data_delivery .

*Selecionar na tabela LIPS os campos VBELN, POSNR, VGBEL e VGPOS,
*relacionados com T_VBAP, onde LIPS-VGBEL = T_VBAP-VBELN e LIPS-VGPOS =
*T_VBAP-POSNR e LIPS-PSTYV = ‘TAN’. Armazenar registros na tabela interna T_LIPS.

*+-------------+     +-------------+      +-------------+
*|   VBAK      |     |   VBAP      |      |   LIPS      |
*+-------------+     +-------------+      +-------------+
*| VBELN (PK)  |<--->| VBELN (FK,PK)|<--->| VBELN (PK)  |
*| ...         |     | POSNR (PK)  |      | ...         |
*+-------------+     | ...         |      | VGBEL (FK)  |
*                    +-------------+      | VGPOS (FK)  |
*                                         +-------------+

  SELECT vbeln, "Selecione o Documento de Vendas
         posnr, "Item do Documento de Vendas
         vgbel, "Nº Documento do Documento de Referência
         vgpos  "Nº Item do Item Comercial Modelo
         FROM lips "Da Tabela Transparente - Documento SD: Fornecimento: Dados de Item
         INTO CORRESPONDING FIELDS OF TABLE @t_lips "Nos Campos correspondentes da Tabela Interna - Documento SD: Fornecimento: Dados de Item
         FOR ALL ENTRIES IN @t_vbap "Relacionado à Tabela Interna - Documento de Vendas: Dados de Item
         WHERE vgbel = @t_vbap-vbeln "Onde fazem parte do mesmo Documento de Vendas
         AND vgpos = @t_vbap-posnr "E são igualmente os mesmos Itens do Documento de Vendas
         AND pstyv = 'TAN'. "E o Tipo de Item de Remessa for padrão."

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_client
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_client .

*Selecionar na tabela KNA1 os campos KUNNR e NAME1, relacionados com
*T_VBAK, onde KNA1-KUNNR = T_VBAK-KUNNR.

*+-------------+     +-------------+
*|   VBAK      |     |   KNA1      |
*+-------------+     +-------------+
*| VBELN (PK)  |     | KUNNR (PK)  |
*| KUNNR (FK)  |<--->| ...         |
*| ...         |     +-------------+
*+-------------+

  SELECT kunnr, "Nº do Cliente
         name1  "Nome do Cliente
         FROM kna1 "Da Tabela Transparente - Mestre de Clientes (Parte Geral)
         INTO CORRESPONDING FIELDS OF TABLE @t_kna1 "Nos campos correspondentes da Tabela Interna - Mestre de Clientes (Parte Geral)
         FOR ALL ENTRIES IN @t_vbak   "Relacionado à Tabela Interna - Documento de Vendas: Dados de Cabeçalho
         WHERE kunnr = @t_vbak-kunnr. "Onde os Números do Cliente são os mesmos.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_text_item
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_text_item .

*Selecionar na tabela MAKT os campos MATNR e MAKTX, relacionados com
*T_VBAP, onde MAKT-MATNR = T_VBAP-MATNR e SPRAS = SY-LANGU. Armazenar
*registros na tabela interna T_MAKT.

*+-------------+     +-------------+
*|   MAKT      |     |   VBAP      |
*+-------------+     +-------------+
*| MATNR (PK)  |<--->| MATNR (FK)  |
*| MAKTX       |     | VBELN (PK)  |
*| ...         |     | POSNR (PK)  |
*+-------------+     | ...         |
*                    +-------------+

  SELECT matnr, "Selecione o Número do Material
         maktx  "Texto Breve de Material
         FROM makt "Da Tabela Transparente - Textos Breves de Material
         INTO CORRESPONDING FIELDS OF TABLE @t_makt "Nos campos correspondentes da Tabela Interna - Textos Breves de Material
         FOR ALL ENTRIES IN @t_vbap "Relacionado à Tabela Interna - Documento de Vendas: Dados de Item
         WHERE matnr = @t_vbap-matnr "Onde os Números de Materiais são os mesmos
         AND spras = @sy-langu. "E onde o idioma for o mesmo do user logado no sistema.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_division_text
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_division_text .

*Selecionar na tabela TGSBT os campos GSBER e GTEXT, relacionados com
*T_VBAP, onde TGSBT-GSBER = T_VBAP-GSBER e SPRAS = SY-LANGU.

*+-------------+        +--------------+
*|    TGSBT    |        |     VBAP     |
*+-------------+        +--------------+
*|   GSBER (PK)| 1    N |   GSBER (FK) |
*|   GSBEZ     |--------|   VBELN (PK) |
*|   ...       |        |   POSNR (PK) |
*+-------------+        |   SPRAS      |
*                       +--------------+

  SELECT gsber, "Selecione Divisão
         gtext  "Denominação da Divisão
         FROM tgsbt "Da Tabela Transparente - Denominação das Divisões da Empresa
         INTO CORRESPONDING FIELDS OF TABLE @t_tgsbt "Nos campos correspondentes da Tabela Interna - Denominação das Divisões da Empresa
         FOR ALL ENTRIES IN @t_vbap "Relacionado à Tabela Interna - Documento de Vendas: Dados de Item
         WHERE gsber = @t_vbap-gsber. "Onde o material pertence à unidade da empresa.
         "AND spras = @sy-langu. "E onde o idioma for o mesmo do user logado no sistema.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form data_processing
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM data_processing .

*Processamento:
*Dar um loop na tabela interna T_VBAP.
*Ler a tabela interna T_VBAK, onde T_VBAP-VBELN = T_VBAK-VBELN. Se não
*encontrar o registro, ler o próximo da tabela interna T_VBAP.
*Ler a tabela interna T_KNA1, onde T_KNA1-KUNNR = T_VBAK-KUNNR. Se não
*encontrar o registro, ler o próximo da tabela interna T_VBAP.
*Ler a tabela interna T_LIPS, onde T_LIPS-VGBEL = T_VBAP-VBELN e T_LIPSVGPOS = T_VBAP-POSNR.
"Se não encontrar o registro, ler o próximo da tabela interna T_VBAP.
*Ler a tabela interna T_MAKT, onde T_VBAP-MATNR = T_MAKT-MATNR. Se não
*encontrar o registro, ler o próximo da tabela interna T_VBAP.
*Ler a tabela interna T_TGSBT, onde T_TGSBT-GSBER = T_VBAP-GSBER. Se
*não encontrar o registro, ler o próximo da tabela interna T_VBAP.
*Montar a tabela interna de saída.

ENDFORM.
